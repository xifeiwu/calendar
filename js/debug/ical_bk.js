

  /*
   * expandRecurringEvent(_expandComponents) is used to 
   *  expand busytimes using iCalString when month is changed.
   * Notice:
   * The UID of the event must exist, else the busytime created
   * can not found its corresponding event.
   * This method is not important as the 
   */
  testExpandRecurringEvent: function() {
    var self = this;
    function dateToTransport(date) {
      var result = Object.create(null);
      var utc = Date.UTC(
        date.getFullYear(),
        date.getMonth(),
        date.getDate(),
        date.getHours(),
        date.getMinutes(),
        date.getSeconds(),
        date.getMilliseconds()
      );
      var localUtc = date.valueOf();
      var offset = utc - localUtc;
      result.utc = utc;
      result.offset = offset;
      return result;
    }
    var today = new Date();
    var expandDate = new Date();
    expandDate.setDate(today.getDate() + 85);
    var icalObj = {
      'calendarId': 'local-first'
    };

    var eventId = 'local-first-9119c679-c8d9-4758-81a7-ebb670f03a2d';
    var icalString = 'BEGIN:VCALENDAR\r\nPRODID:-//H5OS//Calendar 1.0//EN\r\nVERSION:2.0\r\nBEGIN:VTIMEZONE\r\nTZID:America/Adak\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:-1000\r\nTZOFFSETTO:-1000\r\nDTSTART:20160101T010000\r\nEND:STANDARD\r\nEND:VTIMEZONE\r\nBEGIN:VEVENT\r\nDTSTART;TZID=America/Adak:20160101T010000\r\nDTEND;TZID=America/Adak:20160101T020000\r\nRRULE:FREQ=WEEKLY;BYDAY=FR\r\nDTSTAMP;TZID=America/Adak:20160102T152737\r\nUID:9119c679-c8d9-4758-81a7-ebb670f03a2d\r\nDESCRIPTION:\r\nLOCATION:\r\nSEQUENCE:0\r\nSTATUS:CONFIRMED\r\nSUMMARY:Title\r\nTRANSP:OPAQUE\r\nEND:VEVENT\r\nBEGIN:VEVENT\r\nDTSTART;TZID=America/Adak:20160108T040000\r\nDTEND;TZID=America/Adak:20160108T050000\r\nRECURRENCE-ID;TZID=America/Adak:20160108T040000\r\nDTSTAMP;TZID=America/Adak:20160102T163433\r\nUID:1352d3d9-4bb0-4267-b5bc-6d5014954896\r\nDESCRIPTION:\r\nLOCATION:Com\r\nSEQUENCE:0\r\nSTATUS:CONFIRMED\r\nSUMMARY:Title\r\nTRANSP:OPAQUE\r\nEND:VEVENT\r\nEND:VCALENDAR';
    /**
     * The format of ical component
     * {
     *  'eventId':
     *  'lastRecurrenceId':
     *  'ical':
     *  'iterator':
     *  'calendarId':
     * }
     */
    icalObj.eventId = eventId;
    icalObj.ical = icalString;
    icalObj.lastRecurrenceId = dateToTransport(today);
    var localProvider = providerFactory.get('Local');
    localProvider._expandComponents(icalObj.calendarId, [].concat(icalObj), {
      maxDate: dateToTransport(expandDate)
    },
    (err, pull) => {
      if (!err) {
        self.debug('_expandComponents success');
      }
      var trans = self.app.db.transaction(
        ['icalComponents', 'busytimes'],
        'readwrite'
      );
      trans.oncomplete = function() {
        self.debug('transaction complete.');
      };
      trans.onerror = function(event) {
        self.debug('transaction error.');
      };
      // works ok if no trans argument.
      pull.commit(trans);
    });
  },

  // This string is from yahoo calendar. 
  // recurr-every-week event from Jan.1, delete Jan.8,
  //update the event of Jan.22 and change its date to Jan.20
  yahooIcalString: 'BEGIN:VCALENDAR\r\nPRODID://Yahoo//Calendar//EN\r\nVERSION:2.0\r\nMETHOD:PUBLISH\r\nBEGIN:VEVENT\r\nSUMMARY:Title\r\nCLASS:PUBLIC\r\nDTSTART;TZID=Etc/GMT:20160101T010000Z\r\nDTEND;TZID=Etc/GMT:20160101T020000Z\r\nPRIORITY:0\r\nSEQUENCE:0\r\nSTATUS:CONFIRMED\r\nUID:db693feb-4241-46a8-8125-2e365699ab92\r\nDTSTAMP:20160306T132142Z\r\nORGANIZER;CN=xifei wu;SENT-BY="mailto:sduwxf@yahoo.com":mailto:sduwxf@yahoo\r\n .com\r\nRRULE:FREQ=WEEKLY;INTERVAL=1;BYDAY=FR\r\nX-YAHOO-YID:sduwxf\r\nX-YAHOO-YID:sduwxf\r\nX-YAHOO-YID:sduwxf\r\nTRANSP:OPAQUE\r\nSTATUS:CONFIRMED\r\nX-YAHOO-USER-STATUS:BUSY\r\nX-YAHOO-EVENT-STATUS:BUSY\r\nEND:VEVENT\r\nBEGIN:VEVENT\r\nSUMMARY:Title\r\nCLASS:PUBLIC\r\nDTSTART;TZID=Etc/GMT:20160108T010000Z\r\nDTEND;TZID=Etc/GMT:20160108T020000Z\r\nPRIORITY:0\r\nSEQUENCE:0\r\nSTATUS:CANCELLED\r\nUID:db693feb-4241-46a8-8125-2e365699ab92\r\nRECURRENCE-ID;TZID=Etc/GMT:20160108T010000Z\r\nDTSTAMP:20160306T132142Z\r\nORGANIZER;CN=xifei wu;SENT-BY="mailto:sduwxf@yahoo.com":mailto:sduwxf@yahoo\r\n .com\r\nX-YAHOO-YID:sduwxf\r\nX-YAHOO-YID:sduwxf\r\nTRANSP:OPAQUE\r\nSTATUS:CONFIRMED\r\nX-YAHOO-USER-STATUS:BUSY\r\nX-YAHOO-EVENT-STATUS:BUSY\r\nEND:VEVENT\r\nBEGIN:VEVENT\r\nSUMMARY:Title\r\nCLASS:PUBLIC\r\nDTSTART;TZID=Etc/GMT:20160120T010000Z\r\nDTEND;TZID=Etc/GMT:20160120T020000Z\r\nLOCATION:Com\r\nPRIORITY:0\r\nSEQUENCE:1\r\nSTATUS:CONFIRMED\r\nUID:db693feb-4241-46a8-8125-2e365699ab92\r\nRECURRENCE-ID;TZID=Etc/GMT:20160122T010000Z\r\nDTSTAMP:20160306T132212Z\r\nORGANIZER;CN=xifei wu;SENT-BY="mailto:sduwxf@yahoo.com":mailto:sduwxf@yahoo\r\n .com\r\nX-YAHOO-YID:sduwxf\r\nTRANSP:OPAQUE\r\nSTATUS:CONFIRMED\r\nX-YAHOO-USER-STATUS:BUSY\r\nX-YAHOO-EVENT-STATUS:BUSY\r\nEND:VEVENT\r\nBEGIN:VTIMEZONE\r\nTZID:Europe/London\r\nTZURL:http://tzurl.org/zoneinfo/Europe/London\r\nX-LIC-LOCATION:Europe/London\r\nBEGIN:DAYLIGHT\r\nTZOFFSETFROM:+0000\r\nTZOFFSETTO:+0100\r\nTZNAME:BST\r\nDTSTART:19810329T010000\r\nRRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU\r\nEND:DAYLIGHT\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:+0100\r\nTZOFFSETTO:+0000\r\nTZNAME:GMT\r\nDTSTART:19961027T020000\r\nRRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU\r\nEND:STANDARD\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:-000115\r\nTZOFFSETTO:+0000\r\nTZNAME:GMT\r\nDTSTART:18471201T000000\r\nRDATE:18471201T000000\r\nEND:STANDARD\r\nBEGIN:DAYLIGHT\r\nTZOFFSETFROM:+0000\r\nTZOFFSETTO:+0100\r\nTZNAME:BST\r\nDTSTART:19160521T020000\r\nRDATE:19160521T020000\r\nRDATE:19170408T020000\r\nRDATE:19180324T020000\r\nRDATE:19190330T020000\r\nRDATE:19200328T020000\r\nRDATE:19210403T020000\r\nRDATE:19220326T020000\r\nRDATE:19230422T020000\r\nRDATE:19240413T020000\r\nRDATE:19250419T020000\r\nRDATE:19260418T020000\r\nRDATE:19270410T020000\r\nRDATE:19280422T020000\r\nRDATE:19290421T020000\r\nRDATE:19300413T020000\r\nRDATE:19310419T020000\r\nRDATE:19320417T020000\r\nRDATE:19330409T020000\r\nRDATE:19340422T020000\r\nRDATE:19350414T020000\r\nRDATE:19360419T020000\r\nRDATE:19370418T020000\r\nRDATE:19380410T020000\r\nRDATE:19390416T020000\r\nRDATE:19400225T020000\r\nRDATE:19460414T020000\r\nRDATE:19470316T020000\r\nRDATE:19480314T020000\r\nRDATE:19490403T020000\r\nRDATE:19500416T020000\r\nRDATE:19510415T020000\r\nRDATE:19520420T020000\r\nRDATE:19530419T020000\r\nRDATE:19540411T020000\r\nRDATE:19550417T020000\r\nRDATE:19560422T020000\r\nRDATE:19570414T020000\r\nRDATE:19580420T020000\r\nRDATE:19590419T020000\r\nRDATE:19600410T020000\r\nRDATE:19610326T020000\r\nRDATE:19620325T020000\r\nRDATE:19630331T020000\r\nRDATE:19640322T020000\r\nRDATE:19650321T020000\r\nRDATE:19660320T020000\r\nRDATE:19670319T020000\r\nRDATE:19680218T020000\r\nRDATE:19720319T020000\r\nRDATE:19730318T020000\r\nRDATE:19740317T020000\r\nRDATE:19750316T020000\r\nRDATE:19760321T020000\r\nRDATE:19770320T020000\r\nRDATE:19780319T020000\r\nRDATE:19790318T020000\r\nRDATE:19800316T020000\r\nEND:DAYLIGHT\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:+0100\r\nTZOFFSETTO:+0000\r\nTZNAME:GMT\r\nDTSTART:19161001T030000\r\nRDATE:19161001T030000\r\nRDATE:19170917T030000\r\nRDATE:19180930T030000\r\nRDATE:19190929T030000\r\nRDATE:19201025T030000\r\nRDATE:19211003T030000\r\nRDATE:19221008T030000\r\nRDATE:19230916T030000\r\nRDATE:19240921T030000\r\nRDATE:19251004T030000\r\nRDATE:19261003T030000\r\nRDATE:19271002T030000\r\nRDATE:19281007T030000\r\nRDATE:19291006T030000\r\nRDATE:19301005T030000\r\nRDATE:19311004T030000\r\nRDATE:19321002T030000\r\nRDATE:19331008T030000\r\nRDATE:19341007T030000\r\nRDATE:19351006T030000\r\nRDATE:19361004T030000\r\nRDATE:19371003T030000\r\nRDATE:19381002T030000\r\nRDATE:19391119T030000\r\nRDATE:19451007T030000\r\nRDATE:19461006T030000\r\nRDATE:19471102T030000\r\nRDATE:19481031T030000\r\nRDATE:19491030T030000\r\nRDATE:19501022T030000\r\nRDATE:19511021T030000\r\nRDATE:19521026T030000\r\nRDATE:19531004T030000\r\nRDATE:19541003T030000\r\nRDATE:19551002T030000\r\nRDATE:19561007T030000\r\nRDATE:19571006T030000\r\nRDATE:19581005T030000\r\nRDATE:19591004T030000\r\nRDATE:19601002T030000\r\nRDATE:19611029T030000\r\nRDATE:19621028T030000\r\nRDATE:19631027T030000\r\nRDATE:19641025T030000\r\nRDATE:19651024T030000\r\nRDATE:19661023T030000\r\nRDATE:19671029T030000\r\nRDATE:19711031T030000\r\nRDATE:19721029T030000\r\nRDATE:19731028T030000\r\nRDATE:19741027T030000\r\nRDATE:19751026T030000\r\nRDATE:19761024T030000\r\nRDATE:19771023T030000\r\nRDATE:19781029T030000\r\nRDATE:19791028T030000\r\nRDATE:19801026T030000\r\nRDATE:19811025T020000\r\nRDATE:19821024T020000\r\nRDATE:19831023T020000\r\nRDATE:19841028T020000\r\nRDATE:19851027T020000\r\nRDATE:19861026T020000\r\nRDATE:19871025T020000\r\nRDATE:19881023T020000\r\nRDATE:19891029T020000\r\nRDATE:19901028T020000\r\nRDATE:19911027T020000\r\nRDATE:19921025T020000\r\nRDATE:19931024T020000\r\nRDATE:19941023T020000\r\nRDATE:19951022T020000\r\nEND:STANDARD\r\nBEGIN:DAYLIGHT\r\nTZOFFSETFROM:+0100\r\nTZOFFSETTO:+0200\r\nTZNAME:BDST\r\nDTSTART:19410504T020000\r\nRDATE:19410504T020000\r\nRDATE:19420405T020000\r\nRDATE:19430404T020000\r\nRDATE:19440402T020000\r\nRDATE:19450402T020000\r\nRDATE:19470413T020000\r\nEND:DAYLIGHT\r\nBEGIN:DAYLIGHT\r\nTZOFFSETFROM:+0200\r\nTZOFFSETTO:+0100\r\nTZNAME:BST\r\nDTSTART:19410810T030000\r\nRDATE:19410810T030000\r\nRDATE:19420809T030000\r\nRDATE:19430815T030000\r\nRDATE:19440917T030000\r\nRDATE:19450715T030000\r\nRDATE:19470810T030000\r\nEND:DAYLIGHT\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:+0100\r\nTZOFFSETTO:+0100\r\nTZNAME:BST\r\nDTSTART:19681027T000000\r\nRDATE:19681027T000000\r\nEND:STANDARD\r\nBEGIN:STANDARD\r\nTZOFFSETFROM:+0000\r\nTZOFFSETTO:+0000\r\nTZNAME:GMT\r\nDTSTART:19960101T000000\r\nRDATE:19960101T000000\r\nEND:STANDARD\r\nEND:VTIMEZONE\r\nEND:VCALENDAR',


  // var exDateProp = new ICAL.Property('EXDATE');
  // exDateProp.setParameter('TZID', vTimezone.tzid);
  // exDateProp.setParameter('VALUE', 'DATE');
  // exDateProp.setValue(recurringDate.toJSDate().toString('yyyyMMddTHHmmss'));
  // EXDATE;TZID=Asia/Shanghai;VALUE=DATE:20160108T010000
